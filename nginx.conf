# Nginx 配置 - Profile 项目生产环境代理
# 
# Docker 部署步骤：
# 1. 将此文件复制到服务器: /opt/nginx/conf.d/http/profile.conf
# 2. 将构建产物复制到: /opt/nginx/html/profile/
# 3. 重启 nginx 容器: docker restart nginx
#
# 目录映射关系（宿主机 -> 容器）：
# /opt/nginx/html          -> /usr/share/nginx/html
# /opt/nginx/conf.d/http   -> /etc/nginx/conf.d/http
# /opt/nginx/conf.d/cert   -> /etc/nginx/conf.d/cert
# /opt/nginx/logs          -> /var/log/nginx

# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name linxianglive.cn www.linxianglive.cn;
    return 301 https://$host$request_uri;
}

# HTTPS 主配置
server {
    listen 443 ssl http2;
    server_name linxianglive.cn www.linxianglive.cn;

    # SSL 配置
    ssl_certificate /etc/nginx/conf.d/cert/www.linxianglive.cn_bundle.pem;
    ssl_certificate_key /etc/nginx/conf.d/cert/www.linxianglive.cn.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # 静态文件根目录（容器内路径）
    root /usr/share/nginx/html/profile;
    index index.html;

    # 字符集
    charset utf-8;

    # 日志（容器内路径）
    access_log /var/log/nginx/profile_access.log;
    error_log /var/log/nginx/profile_error.log;

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 256;
    gzip_proxied any;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/json
        application/xml
        application/xml+rss
        image/svg+xml;

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # ============================================
    # SSG 模式 - Notion 数据已在构建时静态化
    # 无需 API 代理，数据存储在 /data/articles.json
    # ============================================

    # 静态数据文件缓存
    location /data/ {
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
        try_files $uri =404;
    }

    # ============================================
    # 前端静态资源配置
    # ============================================

    # 静态资源目录 - 优先级最高，确保图片等资源正确访问
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # 图片资源
    location ~* \.(png|jpg|jpeg|gif|ico|svg|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # 字体资源
    location ~* \.(woff|woff2|ttf|eot|otf)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
        try_files $uri =404;
    }

    # JS/CSS 资源
    location ~* \.(js|css)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # 健康检查端点
    location = /health {
        access_log off;
        return 200 "OK";
        add_header Content-Type text/plain;
    }

    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # SPA 路由支持 - 所有其他请求返回 index.html（放在最后）
    location / {
        try_files $uri $uri/ /index.html;
    }
}

# ============================================
# Docker 部署调试命令
# ============================================
#
# 1. 复制配置文件到服务器:
#    scp nginx.conf user@server:/opt/nginx/conf.d/http/profile.conf
#
# 2. 复制构建产物到服务器:
#    npm run build
#    scp -r dist/* user@server:/opt/nginx/html/profile/
#
# 3. 测试 nginx 配置:
#    docker exec nginx nginx -t
#
# 4. 重载 nginx 配置:
#    docker exec nginx nginx -s reload
#    # 或重启容器
#    docker restart nginx
#
# 5. 查看错误日志:
#    tail -f /opt/nginx/logs/profile_error.log
#
# 6. 测试 Notion API 代理:
#    curl -X POST https://linxianglive.cn/api/notion/databases/2ba28bdf-58f2-80d3-8c45-000b4c0822f1/query \
#      -H "Content-Type: application/json" \
#      -d '{"page_size": 10}'
#
# 7. 检查静态资源:
#    curl -I https://linxianglive.cn/
#
# ============================================
# 常见问题排查
# ============================================
#
# 1. 图片/资源 404:
#    - 检查文件是否存在: ls -la /opt/nginx/html/profile/
#    - 检查文件权限: chmod -R 755 /opt/nginx/html/profile/
#
# 2. SSL 证书错误:
#    - 检查证书文件是否存在: ls -la /opt/nginx/conf.d/cert/
#    - 检查证书是否过期: openssl x509 -in /opt/nginx/conf.d/cert/www.linxianglive.cn_bundle.pem -noout -dates
#
# 3. API 调用失败:
#    - 检查 Notion API Key 是否正确
#    - 国内服务器可能无法访问 api.notion.com，需要使用 Cloudflare Workers 中转
#    - 查看错误日志: tail -f /opt/nginx/logs/profile_error.log
#
# 4. 502 Bad Gateway:
#    - 检查 nginx 容器是否正常运行: docker ps
#    - 检查容器日志: docker logs nginx
